%set parameter set of the simulation 
clear all 
clc 
close all 
%% Set these values as initial parameters: 
%K_I = [10 -15 0; 0 -15 15; -15 15 0;0 15 -15; -10 0 0; 0 -10 0; 0 0 -5]; 
%K_P = [150 -150 0; 0 -150 150; -150 150 0;0 150 -150;  -100 0 0; 0 -100 0; 0 0 0]; 


% K_I = [1.3597764e+00  -3.7160043e+00   4.5890866e-04;
%     4.9951506e-03  -2.6056125e+00   2.8354429e+00;
%     -3.4784150e+00   4.0478380e+00   6.6371839e-02;
%     1.7789221e-02   2.8570619e+00  -4.4269087e+00;
%     -6.7891000e+00   1.9240368e-01   9.9906045e-04;
%     1.2352865e-02  -1.4424759e+01   9.5136845e-02;
%     7.9312191e-02   0.0000000e+00  -6.7496146e+00];
% 
% K_P = [8.7196866e+01  -2.0683474e+01   4.8215509e-02;
%     3.4295009e-03  -2.6209326e+01   5.3005020e+00;
%     -3.5571680e+01   6.2396862e+01   1.2896335e-03;
%     2.5016119e-02   5.8690440e+01  -6.6908965e+01;
%     -8.3638801e+01   1.9105088e-03   8.7457778e-03;
%     1.2948136e-02  -2.3697408e+01   5.0907847e-02;
%     6.1224996e-02   1.4999252e-02   6.4523038e-02];
% 
% n_set = [8000  9000  5.6274065e+03]';
% actCrit = 0.25;
% deactCrit = 0.25;
% 
% parameters = reshape(transpose(K_I),[1,size(K_I,1)*size(K_I,2)]);
% parameters = [parameters reshape(transpose(K_P),[1,size(K_P,1)*size(K_P,2)])];
% parameters = [parameters transpose(n_set)];
% parameters = [parameters actCrit deactCrit]; 
%% --- 
% parameters = ones(1,47);
% parameters(43:47) = [5000 6500 4000  0.15  0.25];
%parameters = [9.2110080e-01   6.5326093e-01   4.5044572e-01   1.1005502e+00   5.8095665e-01   8.3534193e-01   1.1418881e+00   1.0244275e+00   7.2366215e-01   1.0566756e+00   1.0789376e+00   5.1380544e-01   9.3231970e-01   8.8262665e-01   4.8386712e-01   8.1053186e-01   1.3465794e+00   6.3751672e-01   5.7424690e-01   9.8463376e-01   1.0762841e+00   7.8532532e-01   7.4664950e-01   9.7925799e-01   1.3097016e+00   7.7303944e-01   1.0610478e+00   8.8999990e-01   1.1398435e+00   1.0101732e+00   1.1024765e+00   1.0348122e+00   7.9762243e-01   9.2579577e-01   1.0831839e+00   1.0480795e+00   8.1107085e-01   7.5673445e-01   1.0142730e+00   8.0657809e-01   1.3137070e+00   9.0596967e-01   2.1293285e+03   2.8127596e+03   1.4611331e+03   1.6883504e-01   3.1250000e-01];
%parameters = [1.1243572e+00   6.2225421e-01   4.1069408e-01   7.3276676e-01   2.2566598e-01   6.3326768e-01   4.2160802e-01   5.3318152e-01   1.8004600e-01   4.2883696e-01   1.4112460e+00   9.3030688e-01   2.6915697e-01   9.2931289e-01   1.5548680e-01   5.3521871e-01   3.4942367e-01   1.7209984e-01   3.3341135e-01   2.5972271e-01   5.4589449e-01   4.6353794e-02   8.6029948e-01  -1.0654993e-01  -6.4295485e-01   7.9114379e-01   7.0868588e-01  -5.9135334e-01   2.7006030e-01   7.4957479e-01   9.8995370e-01   3.3127870e-01   1.4009689e-01  -4.9659318e-01   1.2552593e+00   5.9251361e-01   3.1620422e-01   4.2894904e-01   5.6983297e-01   8.5389302e-01  -5.2161671e-01  -4.8821086e-02   1500 1200 1200   1.8407546e-01   2.3026932e-01]; %no subsets ? 
parameters = [1.9080798e+00  -1.3428721e-01   2.4925412e+00   1.6471137e+00   3.4211361e+00   1.7418989e+00   1.8736754e+00   1.1192957e+00   1.5161829e+00   2.4925964e-01   9.2319690e-01   1.0622088e+00   1.9150107e+00   2.1023381e+00   8.7883963e-02   2.4557394e+00   1.4678396e+00   9.8024217e-02   4.6986313e-01   9.9440411e-01   5.3585555e-01   4.6724066e-01   1.4342693e+00   7.7501210e-01   4.1913436e-01   9.4336947e-01   1.6849691e+00   5.9238177e-01   2.4251059e+00   1.3623731e+00   6.4936014e-01   1.1605556e-02   1.2174199e+00   2.6168012e-01   2.0615708e+00   1.8303445e+00   2.6402056e+00   1.6703403e+00   3.3465182e-01   6.2706118e-01   1.1731729e+00   1.1137247e+00   4.8016533e+03   4.0723276e+03   3.4882558e+03  -1.5686446e-02   2.3410948e-01];

s_setP = 3; %number of regions
s_kp_ki = [7 3];
PC.K_P = zeros(s_kp_ki);
PC.K_I = zeros(s_kp_ki);

%setpoint
PC.n_set = transpose(parameters(end-s_setP-1:end-2));
%PC.n_set = parameters(end-s_setP-1:end-2);
%parameters
k = 1;
for i=1:s_kp_ki(1)
    PC.K_I(i,:) = parameters(k:k+s_kp_ki(2)-1);
    PC.K_P(i,:) = parameters(k+s_kp_ki(1)*s_kp_ki(2):k+s_kp_ki(1)*s_kp_ki(2)+s_kp_ki(2)-1);
    k = k + s_kp_ki(2);
end

%activation criterion
%from 0 to 0.20 (activ when at least one region is less than 20% of the setpoint)
PC.actCrit = parameters(end-1);
PC.deactCrit = parameters(end);

%% -- 

%set size of matrices
s_kp_ki = size(PC.K_I);

[accumulations,VHT] = runSim4calib(parameters,s_kp_ki)

